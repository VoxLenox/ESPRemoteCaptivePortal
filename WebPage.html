<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>ESP8266 Captive Portal Command Line</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				cursor: text;
			}

			body {
				background-color: rgb(35, 35, 35);
			}

			#terminal {
				font-family: monospace;
				font-size: large;
				margin: 15px;
				color: white;
			}

			#input-holder {
				position: relative;
				color: rgb(150, 150, 150);
			}

			.input-prompt {
				position: absolute;
				color: inherit;
			}

			#input {
				position: absolute;
				background: transparent;
				color: inherit;
				font-family: inherit;
				font-size: inherit;
				width: 100%;
				border: hidden;
				outline: none;
				resize: none;
				overflow: hidden;
				text-indent: 27px;
			}

			.log {
				font-family: inherit;
				font-size: inherit;
				white-space: pre-wrap;
			}
		</style>
	</head>
	<body>
		<div id="terminal">
			<div id="input-holder">
				<p class="input-prompt">>></p>
				<textarea id="input" rows="1"></textarea>
			</div>
		</div>
		<script>
			const {entries} = Object;
			const terminal = document.getElementById("terminal");
			const inputHolder = document.getElementById("input-holder");
			const input = document.getElementById("input");
			function createOutput(value, disableHTML) {
				let element = value;
				if (!(element instanceof HTMLElement || element instanceof HTMLDocument)) {
					element = document.createElement("pre");
					element.className = "log";
					element[disableHTML ? "textContent" : "innerHTML"] = String(value);
				}
				terminal.append(element, inputHolder);
				return element;
			}
			input.addEventListener("input", inputEvent => {
				input.style.height = 0;
  				input.style.height = input.scrollHeight + "px";
			});
			const commands = {
				help: {
					desc: "Show list of all commands or formats of a command by typing \"help &lt;command?: string&gt;\"",
					usages: {
						"help": "Show list of all commands",
						"help &lt;command: string&gt;": "Show instructions for a command"
					},
					handler(args) {
						if (args.length <= 1) {
							for (const [name, {desc}] of entries(commands))
								createOutput(`<b>${name}:</b> ${desc}`);
						} else {
							const command = commands[args[1]];
							if (command)
								for (const [format, desc] of entries(command.usages))
									createOutput(`<b>${format}</b> - ${desc}`);
							else
							throw new Error("Invalid command, type \"help\" to see all commands.");
						}
					}
				},
				clear: {
					desc: "Clear all messages in the output",
					usages: {"clear": "Clear all messages in the output"},
					handler(args) {
						for (const logElement of document.querySelectorAll(".log"))
							logElement.remove();
					}
				}
			};
			input.addEventListener("keypress", keyboardEvent => {
				if (keyboardEvent.keyCode === 13) {
					keyboardEvent.preventDefault();
					const {value} = input;
					createOutput(`${document.getElementsByClassName("input-prompt")[0].textContent} ${value}`, true).style.color = "rgb(150, 150, 150)";
					try {
						if (value.trim()) {
							const args = value.split(/\s/g);
							const command = commands[args[0]];
							if (command) {
								command.handler(args);
							} else
								throw new Error("Invalid command, type \"help\" to see all commands.");
						}
					} catch (err) {
						createOutput(err).style.color = "rgb(255, 50, 50)"
					}
					input.value = "";
					input.focus();
				}
			});
			window.addEventListener("click", event => input.focus());
			createOutput("Welcome to ESP8266 Remote Captive Portal Command Line, type \"help\" for a list of command you can use.");
		</script>
	</body>
</html>